# Sistema Tracking - Grupo 6

Fecha de versi√≥n: 19-11-2025

1. Estado Actual del Flujo (Snapshot)
   El flujo opera bajo una l√≥gica de "Agente Orquestador". El usuario consulta, Gemini decide si necesita datos de la DB (v√≠a Tool Postgres), estructura la respuesta y el flujo decide qu√© hacer con ella (responder, enviar mail, guardar archivo).

Punto de Entrada: Actualmente activo mediante Chat Trigger (Pruebas internas). Nota: El Webhook HTTP est√°ndar parece desconectado del Agente en esta versi√≥n.

Cerebro (AI Agent): Configurado como "L√≠a".

System Prompt: Altamente estructurado. Fuerza salida JSON estricta (accion, datos, query_sql).

Herramientas: Conexi√≥n directa a Postgres para consultas de lectura (SELECT).

Procesamiento (Code Node): Script JS robusto que limpia y parsea el JSON de Gemini para alimentar el Switch.

Ramas de Acci√≥n (Switch):

drive ‚Üí Sube a Google Drive.

descargar ‚Üí Guarda en disco local.

enviar ‚Üí Env√≠a reporte por Gmail.

visualizar (Default) ‚Üí Responde JSON al cliente.

### Arquitectura del Flujo (Diagrama)

```mermaid
graph TD
    %% Nodos de Entrada
    subgraph Entrada ["üì° Inputs"]
        A["Webhook (Python Client)"] -->|JSON| C{"AI Agent Controller"}
        B["Chat Trigger (Debug)"] -->|Texto| C
    end

    %% El Cerebro
    subgraph Cerebro ["üß† Inteligencia (Gemini)"]
        C <-->|Consultas SQL| D[("Postgres Tool")]
        D -.->|Supabase| DB[("Base de Datos")]
        C -->|Respuesta JSON Cruda| E["JS Code Parser"]
    end

    %% L√≥gica de Negocio
    subgraph Enrutamiento ["üîÄ L√≥gica de Negocio"]
        E -->|JSON Limpio + Acci√≥n| F{"Switch: ¬øQu√© acci√≥n?"}
    end

    %% Ramas de Salida
    subgraph Salidas ["üöÄ Ejecuci√≥n de Tareas"]
        F -->|accion: 'enviar'| G["Generar Excel -> Gmail Node"]
        F -->|accion: 'drive'| H["Generar Excel -> Drive Upload"]
        F -->|accion: 'descargar'| I["Guardar en Disco Local"]
        F -->|accion: 'visualizar'| J["Respuesta JSON Directa"]
    end

    %% Respuestas Finales
    G --> K["Response to Webhook"]
    H --> K
    I --> K
    J --> K

    %% Estilos
    style C fill:#ff9900,stroke:#333,stroke-width:2px,color:white
    style D fill:#336791,stroke:#333,stroke-width:2px,color:white
    style DB fill:#336791,stroke:#333,stroke-width:2px,color:white
    style F fill:#8a2be2,stroke:#333,stroke-width:2px,color:white
```

## Registro de Cambios y Notas T√©cnicas

### ‚úÖ Hitos Completados (FIXES)

"Se arregl√≥ la funcionalidad de GMAIL, ahora manda los mails correctamente. El nodo Send a message est√° correctamente enlazado tras la conversi√≥n a archivo binario (XLSX)."

### üß† Estado del Agente (AI)

"El prompt parece funcionar consistentemente, generando la estructura JSON requerida, pero estar√≠a bueno revisarlo y consultar para optimizar casos borde o inyecciones de prompt."

### üöß Tareas Pendientes (WIP - Work In Progress)

1. Falta trabajar en el nodo Drive y Read/Write files from disk.
2. Tambi√©n hay que formatear correctamente el archivo .xlsx que se genera, ya que las columnas deber√≠an tener nombres claros, adem√°s, hay que evitar subir el archivo con el campo "acci√≥n" y "sql_query"

## Flujo actual

![alt text](./images/19-11-2025.png)
